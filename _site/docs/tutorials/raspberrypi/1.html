<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  
    <title>インターネット同時接続モードの設定 - website</title>

    
  

  <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="http://localhost:4000/assets/css/just-the-docs.css">
  <link rel="stylesheet" href="http://localhost:4000/assets/css/customstyles.css">
  

  
    <script type="text/javascript" src="http://localhost:4000/assets/js/vendor/lunr.min.js"></script>
  
  <script type="text/javascript" src="http://localhost:4000/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>インターネット同時接続モードの設定 | website</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="インターネット同時接続モードの設定" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/docs/tutorials/raspberrypi/1.html" />
<meta property="og:url" content="http://localhost:4000/docs/tutorials/raspberrypi/1.html" />
<meta property="og:site_name" content="website" />
<script type="application/ld+json">
{"@type":"WebPage","headline":"インターネット同時接続モードの設定","url":"http://localhost:4000/docs/tutorials/raspberrypi/1.html","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>

  <div class="page-wrap">
    <div class="side-bar">
      <a href="http://localhost:4000" class="site-title fs-6 lh-tight">website</a>
      <span class="fs-3"><button class="js-main-nav-trigger navigation-list-toggle btn btn-outline" type="button" data-text-toggle="Hide">Menu</button></span>
      <div class="navigation main-nav js-main-nav">
        <nav role="navigation" aria-label="Main navigation">
    <ul class="navigation-list">
      
      <li>
        <h3>Arduino向けチュートリアル</h3>
      </li>
      
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            <li class="navigation-list-item">
              
              <a href="http://localhost:4000/docs/tutorials/arduino/1.html" class="navigation-list-link">ArduinoでFlashAir制御の概要</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            <li class="navigation-list-item">
              
              <a href="http://localhost:4000/docs/tutorials/arduino/2.html" class="navigation-list-link">iSDIO拡張コマンドの作成</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            <li class="navigation-list-item">
              
              <a href="http://localhost:4000/docs/tutorials/arduino/3.html" class="navigation-list-link">カードステータスの読み取り</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            <li class="navigation-list-item">
              
              <a href="http://localhost:4000/docs/tutorials/arduino/4.html" class="navigation-list-link">APモードでの起動</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            <li class="navigation-list-item">
              
              <a href="http://localhost:4000/docs/tutorials/arduino/5.html" class="navigation-list-link">STAモードでの起動</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            <li class="navigation-list-item">
              
              <a href="http://localhost:4000/docs/tutorials/arduino/6.html" class="navigation-list-link">Webページの取得</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
      <li>
        <h3>Raspberry Pi向けチュートリアル</h3>
      </li>
      
        
      
        
      
        
          
        
      
        
          
            <li class="navigation-list-item active">
              
              <a href="http://localhost:4000/docs/tutorials/raspberrypi/1.html" class="navigation-list-link active">インターネット同時接続モードの設定</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            <li class="navigation-list-item">
              
              <a href="http://localhost:4000/docs/tutorials/raspberrypi/2.html" class="navigation-list-link">APIリファレンス</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
      <li>
        <h3>Mbed™向けチュートリアル</h3>
      </li>
      
        
      
        
      
        
          
            <li class="navigation-list-item">
              
              <a href="http://localhost:4000/docs/tutorials/mbed/1.html" class="navigation-list-link">MbedでAPモード起動</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            <li class="navigation-list-item">
              
              <a href="http://localhost:4000/docs/tutorials/mbed/2.html" class="navigation-list-link">APIリファレンス</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    
      <li>
        <br>
        <a href="../../tutorials/isdio">目次に戻る</a>
      </li>
    </ul>
  </nav>
      </div>
      <footer role="contentinfo" class="site-footer">
        <p class="text-small text-grey-dk-000 mb-0">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p>
      </footer>
    </div>
    <div class="main-content-wrap js-main-content" tabindex="0">
      <div class="page-header">
        <div class="main-content">
          
          <div class="search js-search">
            <div class="search-input-wrap">
              <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search website" aria-label="Search website" autocomplete="off">
              <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg>
            </div>
            <div class="js-search-results search-results-wrap"></div>
          </div>
          
          
        </div>
      </div>
      <div class="main-content">
        
          
            <nav class="breadcrumb-nav">
              <ol class="breadcrumb-nav-list">
                
                  <li class="breadcrumb-nav-list-item"><span>チュートリアル</span></li>
                  <li class="breadcrumb-nav-list-item"><span>Raspberry Pi向けチュートリアル</span></li>
                
                <li class="breadcrumb-nav-list-item"><span>インターネット同時接続モードの設定</span></li>
              </ol>
            </nav>
          
        
        <div id="main-content" class="page-content" role="main">
          <h1 id="インターネット同時接続モードの設定">インターネット同時接続モードの設定</h1>

<p>本チュートリアルでは、RaspberryPi上でiSDIOドライバAPIを使用してFlashAirを制御し、 インターネット同時接続モードの設定を行います。</p>

<hr />
<h2 id="サンプル環境">サンプル環境</h2>

<p>HW：Raspberry Pi 3 Model B ＋ microSD-&gt;SD変換アダプタ
OS：Raspbian (NOOBS ver.2.4.3)
NW：インターネット接続が可能なアクセスポイント</p>

<p><img src="/assets/images/tutorials/raspberrypi_01_01.jpg" alt="サンプル環境" class="d-block" /></p>

<p>microSD変換アダプタを使用してRaspberry Pi 3のmicroSDスロットにFlashAirを上図のように接続します。</p>

<hr />
<h2 id="サンプルコード実行手順">サンプルコード実行手順</h2>

<ol>
  <li>事前準備としてFlashAirからRaspberryPiを起動できるよう準備します。<br />
 また、SD_WLANフォルダのCONFIGファイルに<code class="highlighter-rouge">APPMODE=0</code>を記載してください。</li>
  <li>こちらよりサンプルコード環境をダウンロードして、RaspberryPi上に展開します。<br />
展開場所はどこでも構いません。</li>
  <li>
    <p>展開すると下記のような構成で展開されますので、ターミナルからsampleフォルダまで移動します。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iSDIO_tutorial_sample
|-incフォルダ(iSDIOドライバAPI ヘッダ部)
|  |- isdio_api.h
|  |- isdio_wlan_api.h
|  |- isdioreg.h
|  └─ mmc.h
|
|-sampleフォルダ
|  |- iSDIO_tutorial_sample.c (本チュートリアルサンプルコード)
|  └─ Makefile
|
└─srcフォルダ(iSDIOドライバAPI ソース部)
  |- isdio_api.c
  |- isdio_wlan_api.c
  └─ isdioreg.c
</code></pre></div>    </div>
  </li>
  <li>ターミナル上でmakeを実行します。meke成功でsampleフォルダ内に実行ファイル<code class="highlighter-rouge">isdio_sample</code>が作成されます。<br />
 ただし、インターネットに接続するアクセスポイント名、パスワードは環境によって違いますので、<a href="#インターネット同時接続モードの設定-1">こちら</a>を参照して変更してください。</li>
  <li>
    <p>4.で作成されたisdio_sampleを実行します。<br />
 ただし、iSDIOドライバを使用するには管理者権限が必要となります。下記のように実行してください。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; sudo ./isdio_sample
</code></pre></div>    </div>
  </li>
</ol>

<p>ダウンロードしたサンプルコード(iSDIO_tutorial_sample.c)を解説していきます。</p>

<h3 id="isdioドライバの初期化">iSDIOドライバの初期化</h3>

<p>FlashAirを使用するためiSDIOカード制御情報の初期化を行います。</p>

<h5 id="isdio_tutorial_samplec一部参照"><em>iSDIO_tutorial_sample.c(一部参照)</em></h5>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">iSDIO_INFO_t</span> <span class="o">*</span><span class="n">s_info</span><span class="p">;</span>                                   <span class="cm">/* iSDIOカード制御情報ポインタ */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">s_device</span> <span class="o">=</span> <span class="s">"/dev/mmcblk0"</span> <span class="p">;</span>                       <span class="cm">/* SDカードデバイス情報 */</span>

    <span class="cm">/* iSDIO初期化 */</span>
    <span class="n">s_info</span> <span class="o">=</span> <span class="n">iSDIO_Init</span><span class="p">(</span><span class="n">s_device</span><span class="p">);</span>  
    <span class="n">printf</span><span class="p">(</span><span class="s">" info=0x%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">s_info</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s_info</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"info-&gt;fno=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">s_info</span><span class="o">-&gt;</span><span class="n">fno</span><span class="p">);</span>
      <span class="n">system</span><span class="p">(</span><span class="s">"mount /dev/mmcblk0p1 /mnt"</span><span class="p">);</span>
</code></pre></div></div>
<ul>
  <li>33行目<br />
  iSDIOカード制御情報の先頭アドレスを取得するためのポインタを準備します。<br />
  iSDIOカード制御情報はiSDIO_Initの戻り値として取得し、各コマンドおよびレスポンスでハンドラとして使用します。</li>
  <li>34行目<br />
  SDカードデバイス情報はFlashAirのデバイス情報が設定されるため環境によって変更してください。</li>
  <li>53行目<br />
  FlashAirをmountするため、環境によって変更してください。</li>
</ul>

<h3 id="アクセスポイントの検索">アクセスポイントの検索</h3>

<p>FlashAirが認識できるアクセスポイントの検索を行います。</p>

<h5 id="isdio_tutorial_samplec一部参照-1"><em>iSDIO_tutorial_sample.c(一部参照)</em></h5>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/* 周りのアクセスポイントの情報を取得 */</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">iSDIO_WLAN_Scan</span><span class="p">(</span><span class="n">s_info</span><span class="p">,</span> <span class="n">s_seq_id</span> <span class="o">++</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">E_iSDIO_OK</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* iSDIOコマンド実行プロセスの完了を待つ */</span>
      <span class="n">timeout</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>          <span class="cm">/* Scanのタイムアウトは20秒なので、20000ms */</span>
      <span class="n">cmd_success</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
      <span class="cm">/* WLAN_Scanレスポンス待ち */</span>
      <span class="n">cmd_success</span> <span class="o">=</span> <span class="n">response_wait</span><span class="p">(</span><span class="n">s_info</span><span class="p">,</span> <span class="p">(</span><span class="n">s_seq_id</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">iSDIO_WLAN_SCAN</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">cmd_success</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"WLAN_Scan response error !!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
</code></pre></div></div>
<ul>
  <li>55行目<br />
  iSDIO_WLAN_Scanは非同期関数のため62行目でのレスポンス待ちが必要となります。<br />
   55行目のレスポンスはiSDIO_WLAN_Scanコマンド実行の成否となり、62行目のレスポンス待ちはiSDIO_WLAN_Scanコマンド実行結果の成否となります。<br />
   コマンド・レスポンスについては<a href="#コマンド・レスポンスについて">こちら</a>を参照。<br />
   また、引数のシーケンスIDは新しくコマンドを発行するたびにユニークな値を設定します。<br />
   そのため、シーケンスID使用後インクリメントを行っています。</li>
  <li>62行目<br />
  レスポンスデータ取得時には、コマンドIDとシーケンスIDでどのコマンド実行時のレスポンスかを判断します。<br />
   そのため、iSDIO_WLAN_Scanコマンド実行時のシーケンスIDを設定するため現在のシーケンスIDから<code class="highlighter-rouge">-1</code>した値でレスポンス待ちを行っています。</li>
</ul>

<h3 id="インターネット同時接続モードの設定-1">インターネット同時接続モードの設定</h3>

<p>FlashAirを使用してインターネット接続をしながら自身をアクセスポイントに設定します。</p>

<h5 id="isdio_tutorial_samplec一部参照-2"><em>iSDIO_tutorial_sample.c(一部参照)</em></h5>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">uint8_t</span> <span class="n">apssid</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>          <span class="o">=</span> <span class="s">"myflashair"</span><span class="p">;</span>               <span class="cm">/* FlashAir（AP側） 無線LAN SSID */</span>
    <span class="kt">uint8_t</span> <span class="n">apnetworkKey</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span>    <span class="o">=</span> <span class="s">"password0123"</span><span class="p">;</span>             <span class="cm">/* FlashAir（AP側） 無線LAN ネットワークキー */</span>
    <span class="kt">uint8_t</span> <span class="n">brgssid</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>         <span class="o">=</span> <span class="s">"LANSSID"</span><span class="p">;</span>                  <span class="cm">/* インターネット（STA側） 無線LAN SSID */</span>
    <span class="kt">uint8_t</span> <span class="n">brgnetworkKey</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span>   <span class="o">=</span> <span class="s">"lanpassword0123"</span><span class="p">;</span>          <span class="cm">/* インターネット（STA側） 無線LAN ネットワークキー */</span>
    <span class="kt">uint32_t</span> <span class="n">encMode</span>            <span class="o">=</span> <span class="n">iSDIO_WLAN_ENCMODE_WPA2_PSK_AND_AES</span><span class="p">;</span>  <span class="cm">/* 動作モード=6 */</span>

            <span class="cm">/* 周りにアクセスポイントがある場合 */</span>
            <span class="cm">/* アクセスポイント名を取得して対象のSTAがあるか判別 */</span>
            <span class="k">for</span><span class="p">(</span><span class="n">lp</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">lp</span><span class="o">&lt;</span><span class="n">num</span><span class="p">;</span><span class="n">lp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">memset</span><span class="p">(</span><span class="n">getssid</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mi">32</span><span class="p">);</span>            <span class="cm">/* アクセスポイント名取得用バッファクリア */</span>
              <span class="cm">/* 指定番号のアクセスポイント名を取得 */</span>
              <span class="n">result</span> <span class="o">=</span> <span class="n">iSDIO_WLAN_GetSSID</span><span class="p">(</span><span class="n">s_info</span><span class="p">,</span> <span class="n">lp</span> <span class="p">,</span> <span class="n">getssid</span><span class="p">);</span>
              <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">E_iSDIO_OK</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"WLAN_GetSSID get error !!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="n">printf</span><span class="p">(</span><span class="s">"SSID#%d SSID=%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span> <span class="n">getssid</span><span class="p">);</span>
              <span class="k">if</span><span class="p">(</span><span class="n">strstr</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">getssid</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">brgssid</span><span class="p">))</span> <span class="p">{</span>
                <span class="cm">/* 対象のSTAありでBridge設定*/</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">iSDIO_WLAN_Bridge</span><span class="p">(</span><span class="n">s_info</span><span class="p">,</span> <span class="n">s_seq_id</span><span class="o">++</span><span class="p">,</span>
                            <span class="n">apssid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">apssid</span><span class="p">),</span>
                            <span class="n">apnetworkKey</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">apnetworkKey</span><span class="p">),</span>
                            <span class="n">encMode</span><span class="p">,</span>
                            <span class="n">brgssid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">brgssid</span><span class="p">),</span>
                            <span class="n">brgnetworkKey</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">brgnetworkKey</span><span class="p">));</span>
                <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">E_iSDIO_OK</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"Bridge Set error!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>
</code></pre></div></div>
<ul>
  <li>93行目<br />
  FlashAir自身がアクセスポイントとなるためのSSIDとそのレングス長を設定します。</li>
  <li>94行目<br />
  アクセスポイントのネットワークキーとそのレングス長を設定します。</li>
  <li>95行目<br />
  アクセスポイントの動作モードを設定します。インターネット同時接続モード場合は動作モード=6固定となります。</li>
  <li>96行目<br />
  インターネットと接続しているステーション側のSSIDとそのレングス長を設定します。</li>
  <li>97行目<br />
  インターネットと接続しているステーション側のネットワークキーとそのレングス長を設定します。</li>
</ul>

<p><span class="badge label-yellow">注意点</span>
iSDIO_WLAN_BridgeはFlashAirがDisconnect状態でないと機能しません。<br />
FlashAirがすでに別の機器接続状態の場合は、まずはiSDIO_WLAN_Disconnectを実行してください。<br />
接続状態を知りたい場合は、iSDIO_WLAN_Check_WLANConnectを実行すると、引数connectに接続状態が出力されます。</p>

<h3 id="レスポンス待ち処理">レスポンス待ち処理</h3>

<p>非同期コマンドの結果を待つ、レスポンス待ち処理について説明しておきます。</p>

<h5 id="isdio_tutorial_samplec一部参照-3"><em>iSDIO_tutorial_sample.c(一部参照)</em></h5>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/* コマンドレスポンス待ちサンプル関数 */</span>
    <span class="n">bool_t</span> <span class="nf">response_wait</span><span class="p">(</span><span class="n">iSDIO_INFO_t</span> <span class="o">*</span><span class="n">s_info</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">seq_id</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">cmd_id</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">iSDIO_CommandResponseStatus_t</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
      <span class="kt">int32_t</span> <span class="n">timeout_cnt</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>    <span class="c1">// ms / 10
</span>      <span class="n">bool_t</span> <span class="n">cmd_success</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

      <span class="cm">/* コマンドレスポンスステータスが実行中から抜けるかタイムアウトするまでループする */</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">iSDIO_ReadCommandResponseStatus</span><span class="p">(</span><span class="n">s_info</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">response_status</span> <span class="o">!=</span> <span class="n">iSDIO_COMMAND_PROCESSING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">cmd_id</span><span class="o">==</span><span class="n">cmd_id</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">response_status</span> <span class="o">==</span> <span class="n">iSDIO_PROCESS_SUCCEEDED</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cmd_success</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
          <span class="n">printf</span><span class="p">(</span><span class="s">"res_wait=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">response_status</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>    <span class="c1">// 10ms待つ
</span>        <span class="n">timeout_cnt</span> <span class="o">--</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">timeout_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">cmd_success</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>
<ul>
  <li>160行目<br />
  FlashAirのレジスタ情報Command Response Statusを読み出す内部関数。<br />
  コマンドのレスポンスステータスを取得します。</li>
  <li>161行目<br />
  レスポンスステータスが処理中ではなく、実施したコマンドのレスポンスであるならレスポンス正常でレスポンス待ちを抜け、戻り値にTRUEを返しています。</li>
  <li>168-170行目<br />
  レスポンスステータスがまだ処理中の場合のタイムアウト処理。<br />
  このサンプルでは10ms単位でレスポンスステータスの確認を行い、引数のtimeout時間分レスポンス待ちを行っています。<br />
  タイムアウトの場合は戻り値にFALSEを返しています。</li>
</ul>

<hr />
<h2 id="実行結果">実行結果</h2>

<p>実行してみましょう。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; sudo ./isdio_sample
dev/mmcblk0 open success
info=0x27268
info-&gt;fno=1
SSID#1 SSID=LANSSID
WLAN_Bridge set success
WLAN_BridgeGetInfoByRegister get response success
</code></pre></div></div>

<ul>
  <li>2-4行目<br />
  FlashAirを正常に認識した場合のみ成功のログ表示とFlashAirのデバイスハンドルIDが表示されます。</li>
  <li>5行目<br />
  SSIDが見つかった順番とアクセスポイント名は該当のアクセスポイントが見つかるか、Scanで発見されたアクセスポイント数分表示されます。<br />
  最後に表示されたものが該当のアクセスポイントとなります。<br />
  発見できなかった場合はエラーログが表示されます。</li>
  <li>6行目<br />
  インターネット同時接続モードの設定が成功した場合のみ成功のログ表示がされます。<br />
  接続失敗の場合はエラーログが表示されます。</li>
  <li>7行目<br />
  ブリッジ情報の取得が成功した場合のみ成功のログ表示がされます。<br />
  インターネットにつながっていないPC・スマートフォンなどから「myflashair」というSSIDに繋ぎ、<code class="highlighter-rouge">http://flashair/</code>にアクセスできることを確認してください。<br />
  また、インターネットに接続できることを確認してください。<br />
  情報取得失敗の場合はエラーログが表示されます。</li>
</ul>

<hr />
<h2 id="コマンドレスポンスについて">コマンド・レスポンスについて</h2>

<p>非同期となるコマンドは下記となります。</p>

<ul>
  <li>iSDIO_WLAN_Scan</li>
  <li>iSDIO_WLAN_Connect</li>
  <li>iSDIO_WLAN_Establish</li>
  <li>iSDIO_WLAN_WiFiDirect</li>
  <li>iSDIO_WLAN_StartWPS</li>
  <li>iSDIO_WLAN_StartWPSAP</li>
  <li>iSDIO_WLAN_Disconnect</li>
  <li>iSDIO_WLAN_SetCurrentTime</li>
  <li>iSDIO_WLAN_Abort</li>
  <li>iSDIO_WLAN_ReadResponse</li>
  <li>iSDIO_WLAN_SetPowerSaveMode</li>
  <li>iSDIO_WLAN_SetCannel</li>
  <li>iSDIO_WLAN_SendHTTPMessageByRegister</li>
  <li>iSDIO_WLAN_SendHTTPFileByRegister</li>
  <li>iSDIO_WLAN_SendHTTPSSLMessageByRegister</li>
  <li>iSDIO_WLAN_SendHTTPSSLFileByRegister</li>
  <li>iSDIO_WLAN_SendHTTPMessageByFile</li>
  <li>iSDIO_WLAN_SendHTTPFileByFile</li>
  <li>iSDIO_WLAN_SendHTTPSSLMessageByFile</li>
  <li>iSDIO_WLAN_SendHTTPSSLFileByFile</li>
  <li>iSDIO_WLAN_Request</li>
  <li>iSDIO_WLAN_SetCertificate</li>
  <li>iSDIO_WLAN_SetCertificateByFile</li>
  <li>iSDIO_WLAN_StartP2PSender</li>
  <li>iSDIO_WLAN_StartP2PReceiver</li>
  <li>iSDIO_WLAN_GetFile</li>
  <li>iSDIO_WLAN_ReadIDList</li>
  <li>iSDIO_WLAN_SelectMAC</li>
  <li>iSDIO_WLAN_DeselectMAC</li>
  <li>iSDIO_WLAN_SetID</li>
  <li>iSDIO_WLAN_Bridge</li>
  <li>iSDIO_WLAN_BridgeGetByRegister</li>
</ul>

<p>同期となるコマンドは下記となります。</p>

<ul>
  <li>iSDIO_Init</li>
  <li>iSDIO_WLAN_WriteSharedMemory</li>
  <li>iSDIO_WLAN_ReadSharedMemory</li>
  <li>iSDIO_WLAN_GetFlashAirVersion</li>
  <li>iSDIO_WLAN_GetSSIDs</li>
  <li>iSDIO_WLAN_GetSSID</li>
  <li>iSDIO_WLAN_GetStatusData</li>
  <li>iSDIO_WLAN_GetResponseData</li>
  <li>iSDIO_WLAN_GetVersion</li>
  <li>iSDIO_WLAN_SetWaitResponseTime</li>
  <li>iSDIO_WLAN_Check_WLANConnect</li>
  <li>iSDIO_WLAN_Check_WLAN</li>
  <li>iSDIO_WLAN_Get_WLAN_Status</li>
</ul>

<hr />
<h2 id="サンプルコード環境一式">サンプルコード環境一式</h2>

<p><a href="/files/samplecode/raspberrypi/iSDIO_tutorial_sample.zip" class="btn btn-primary">iSDIO_tutorial_sample.zip</a> (24KB)</p>


          
        </div>
      </div>
    </div>
  </div>

</body>
</html>
